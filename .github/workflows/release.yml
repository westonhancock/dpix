name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install root dependencies
        run: npm install

      - name: Install CLI dependencies
        run: cd packages/cli && npm install

      - name: Install Electron dependencies
        run: cd packages/electron && npm install

      - name: Build standalone binaries
        run: npm run build:binary

      - name: Build Electron app
        run: npm run build:electron

      - name: Create .dmg installer
        run: npm run build:dmg

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release-notes.md << 'EOF'
          ## dpix v${{ steps.version.outputs.VERSION }}

          Image optimization for everyone - CLI, menu bar app, and Quick Actions for macOS.

          ### ðŸ“¦ Installation

          **CLI (Recommended)**
          ```bash
          npm install -g dpix
          ```

          **Menu Bar App**
          1. Download the appropriate DMG below:
             - **Apple Silicon (M1/M2/M3)**: `dpix-{version}-arm64.dmg`
             - **Intel Macs**: `dpix-{version}-x64.dmg`
          2. Open DMG and drag dpix.app to Applications
          3. **âš ï¸ First launch:** Right-click dpix.app â†’ Open â†’ Open (bypasses Gatekeeper)

          > **Note:** This app is not yet code-signed. macOS Gatekeeper will block it on first launch. See the [Installation Guide](https://github.com/westonhancock/dpix/blob/main/INSTALLATION.md) for detailed bypass instructions.

          ### What's Included

          - **Menu Bar App** - Drag & drop interface with global hotkey (Cmd+Shift+O)
          - **Quick Action** - Right-click any image â†’ "Optimize Image" (requires manual installation)
          - **CLI Tool** - Command line interface for automation

          ### âœ¨ Features

          - Resize images by width, height, or both
          - Adjust quality (1-100) with intelligent defaults
          - Convert to modern formats (WebP, AVIF, HEIC) or traditional (JPG, PNG, GIF, TIFF)
          - Real-time progress indicators
          - Batch processing support
          - Drag & drop interface

          ### ðŸ“š Documentation

          - **[Installation Guide](https://github.com/westonhancock/dpix/blob/main/INSTALLATION.md)** - Detailed installation and troubleshooting
          - [README](https://github.com/westonhancock/dpix/blob/main/README.md) - Project overview
          - [Roadmap](https://github.com/westonhancock/dpix/blob/main/ROADMAP.md) - Upcoming features

          ### Requirements

          - macOS 11.0 or later
          - For CLI: Node.js >= 18.0.0
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: dpix v${{ steps.version.outputs.VERSION }}
          body_path: release-notes.md
          files: |
            dist/dpix-installer-arm64.dmg
            dist/dpix-macos-arm64
            dist/dpix-macos-x64
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dpix-v${{ steps.version.outputs.VERSION }}
          path: |
            dist/dpix-installer-arm64.dmg
            dist/dpix-macos-arm64
            dist/dpix-macos-x64
